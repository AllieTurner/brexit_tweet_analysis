<!DOCTYPE html>
<!--Created by SVT:s Quickshot team: https://www.svt.se/pejl/-->
<meta charset="utf-8">
<head>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link rel="stylesheet" type="text/css" href="fonts/fonts.min.css" />
    <style>
        body {
            font-family: 'proxima_nova_ltsemibold',Georgia, sans-serif;
            background: #000000;
        }
        #viz {
            width: 100%;
            height: 700px;
        }
        .y-axis line {
            stroke: white;
        }
        .y-axis path {
            stroke: white;
        }
        .y-axis text {
            fill: white;
        }


    </style>
</head>

<body id="background">
<div id="viz"></div>
<button id="left"><</button>
<button id="right">></button>

<script>

    Element.prototype.remove = function() {
        this.parentElement.removeChild(this);
    };
    NodeList.prototype.remove = HTMLCollection.prototype.remove = function() {
        for(var i = this.length - 1; i >= 0; i--) {
            if(this[i] && this[i].parentElement) {
                this[i].parentElement.removeChild(this[i]);
            }
        }
    };

    // get width and height from viz-div

    var divWidth = document.getElementById("viz").clientWidth;
    var divHeight = document.getElementById("viz").clientHeight;

    var height = divHeight;
    var width = divWidth;

    var margin = {top: height*0.1, right: width * 0.08, bottom: height * 0.06, left: width * 0.08};

    width = width - margin.left - margin.right;
    height = height - margin.top - margin.bottom;


    var svg = d3.select("#viz").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("class", "chart")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var background = svg.append("rect")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("transform", "translate(" + (-margin.left) + "," + (-margin.top) + ")")
            .attr("fill", "transparent");


    var radius = 3;

    var defaultColor = "white";

    var highlightColor = "grey";

    var updateDuration = 1500;

    var activeForces = [];

    var counter = 0;

    var barYactive = false;

    var top10_data = false;
    var top10 = [false,false,false,false,false,false,false,false,false,false];
    d3.csv("pre_brexit_data_small.csv", function(error, data) {
        if (error) throw error;

        data.forEach(function(d) {
            d.fade = 1;
            d.color = defaultColor;
            d.age = Math.floor(d.age / 60 / 60 / 24 / 30);
            if (d.position == ""){
                d.position = false
            }else{
                var lat = Number(d.position.split(',')[0].split('(')[1]); //* Math.PI / 180;
                var long = Number(d.position.split(',')[1].split(')')[0]); //* Math.PI / 180;
                mapWidth    = divWidth;
                mapHeight   = divHeight;
                PI = Math.PI;
                log = Math.log;
                tan = Math.tan;
                //166
                var x = (long+140)*(mapWidth/360);
                // convert from degrees to radians
                var latRad = lat*PI/180;
                var mercN = log(tan((PI/4)+(latRad/2)));
                //20
                y     = (mapHeight/2 - 7)-(mapWidth*mercN/(2*PI));
                d.posy = y;
                d.posx = x;
            }
        });

        /* scales */

        var randomX = d3.scaleLinear()
                .domain([0, 1])
                .range([0, width-radius]);

        var randomY = d3.scaleLinear()
                .domain([0, 1])
                .range([0, height-radius]);

        /* define and init simulation */

        var simulation = d3.forceSimulation();

        simulation
                .nodes(data)
                .on("tick", ticked);


        initSim();
        /* basic simulation functions */

        function initSim() {
            simulation
                    .force("x", d3.forceX(function(d) {
                        return randomX(Math.random())
                    }))
                    .force("y", d3.forceY(function(d) {
                        return randomY(Math.random())
                    }))
                    .alphaMin(0.5)
                    .stop();
            // loop through simulation ticks to land in a stable state with randomly distributed nodes
            for (var i = 0; i < 100; ++i) simulation.tick()

            activeForces.push("x", "y");

            return simulation
        }

        function getColor(location){
            var country = "";
            if(location.indexOf(',') != -1){
               country = location.split(",")[1].substr(1)
            }else{
                country = location
            }
            switch (country){
                case "United Kingdom":
                case "England":
                case "Wales":
                case "Scotland":
                case "France":
                case "Germany":
                case "Spain":
                case "Ireland":
                case "Belgium":
                case "Netherlands":
                case "Italy":
                case "Sweden":
                case "Greece":
                case "Poland":
                case "Catalunya":
                case "Denmark":
                    return "#3366cc";
                case "United States":
                case "Canada":
                case "Mexico":
                    return "#CC33FF";
                case "India":
                case "Singapore":
                case "Thailand":
                case "China":
                case "UAE":
                    return "#ccff66";
                case "Australia":
                    return "#ff6633";
                case "South Africa":
                case "Nigeria":
                    return "#996666";
                default:
                    return "#FFFFFF"
            }

        }


        function baseSim(alphaMin) {
            /* creates basic petri dish of nodes */

            removeForces();
            radius = 1;

            simulation
                    .stop()
                    .force("charge", d3.forceManyBody().strength(-2))
                    .force("x", d3.forceX(width/2).strength(0.12))
                    .force("y", d3.forceY(height/2).strength(0.12))
                    .force("collide", d3.forceCollide(radius))
                    .alphaMin(alphaMin)
                    .alpha(1)
                    .restart();
            activeForces.push("charge", "x", "y", "collide");


            return simulation

        }


        function breakdown(breakdownObjects) {
            /* breaks down nodes into groups centers of gravity defined by x and y functions */

            var radius = 1;

            removeForces();

            for (i=0; i<breakdownObjects.length; i++) {
                switch(breakdownObjects[i]["type"]) {

                    case "xy":
                        var customX = d3.forceX(breakdownObjects[i]["breakX"]).strength(breakdownObjects[i]["strengthX"])
                        var customY = d3.forceY(breakdownObjects[i]["breakY"]).strength(breakdownObjects[i]["strengthY"])


                        simulation
                                .force("x" + i.toString(), customX)
                                .force("y" + i.toString(), customY);
                        activeForces.push("x" + i.toString());
                        activeForces.push("y" + i.toString());

                        break;

                    case "charge":
                        var customCharge = isolate(d3.forceManyBody(), breakdownObjects[i]["filter"]).strength(breakdownObjects[i]["strength"])
                        simulation
                                .force("charge" + i.toString(), customCharge);
                        activeForces.push("charge" + i.toString());

                        break;
                }
            }

            simulation
                    .force("collide", d3.forceCollide(radius))
                    .alpha(1)
                    .alphaMin(0.4)
                    .restart();

            activeForces.push("collide");


            return simulation
        }


        function breakdownMap(breakdownObjects) {
            /* breaks down nodes into groups centers of gravity defined by x and y functions */

            var radius = 0.5;

            removeForces();

            for (i=0; i<breakdownObjects.length; i++) {
                switch(breakdownObjects[i]["type"]) {

                    case "xy":
                        var customX = d3.forceX(breakdownObjects[i]["breakX"]).strength(breakdownObjects[i]["strengthX"])
                        var customY = d3.forceY(breakdownObjects[i]["breakY"]).strength(breakdownObjects[i]["strengthY"])


                        simulation
                                .force("x" + i.toString(), customX)
                                .force("y" + i.toString(), customY);
                        activeForces.push("x" + i.toString());
                        activeForces.push("y" + i.toString());

                        break;

                    case "charge":
                       // var customCharge = isolate(d3.forceManyBody(), breakdownObjects[i]["filter"]).strength(breakdownObjects[i]["strength"])
                       // simulation
                       //         .force("charge" + i.toString(), customCharge);
                       // activeForces.push("charge" + i.toString());

                        break;
                }
            }

            simulation
                    .force("collide", d3.forceCollide(radius))
                    .alpha(1)
                    .alphaMin(0.4)
                    .restart();

            activeForces.push("collide");


            return simulation
        }

        function breakout(filterIn, filterOut) {
            /* breakout a selection of nodes by lifting them out from petri dish to a radial circle and fading out the non-selected nodes */

            removeForces();

            var customRadial = isolate(d3.forceRadial(width * 0.7, width / 2, height / 2), filterOut).strength(0.12);


            var customCenter = isolate(d3.forceCenter(width / 2, height / 2), filterIn);

            simulation.stop()
                    .force("center", customCenter)
                    .force("radial", customRadial)
                    .force("collide", d3.forceCollide(radius))
                    .alpha(1)
                    .alphaMin(0.6)
                    .restart()
                    .on("end", null);

            activeForces.push("center", "radial", "collide");


            return simulation

        }
        function splitMap(){
            var xFunction = function(d) {
                return d.position? d.posx : 0
            };
            var yFunction = function(d) {
                return d.position? d.posy : 0
            };

            var breakdownObjs = [{"type": "xy", "breakX": xFunction, "strengthX": 0.15, "breakY": yFunction, "strengthY": 0.15}, {"type": "charge", "filter": function(d) { return d; },"strength": -1.5}]

            breakdownMap(breakdownObjs)
        }

        var barYaxisDOM; // defined here in order to be accessible for removal by resetForces function

        function barchartY(filterFunction, accessor) {
            /* creates a bar chart on the left hand side from values (not a force function!) */
            removeForces();

            var barY = d3.scaleLinear()
                    .domain(d3.extent(data.filter(filterFunction), function(d) {
                        return +accessor(d) }))
                    .range([height, 0]);

            var barYaxis = d3.axisRight(barY);

            var xValObj = {};

            simulation.stop();

            radius = 3;

            if (width > height) {
                var radiusMulti = 3
            } else {
                var radiusMulti = 2
            }
            circles
                    .transition()
                    .duration(1500)
                    .attr("opacity", function(d) { return d.fade })
                    .attr("fill", function(d) { return getColor(d.location); })
                    .attr("cy", function(d) {
                        var y = barY(+accessor(d));
                        // manually update d.x to let simulation know x has changed
                        d.y = y;
                        return d.y;
                    })
                    .attr("cx", function(d) {
                        if (xValObj[accessor(d)]) {
                            var x = width - ((xValObj[accessor(d)] += 1) * (radius * radiusMulti));
                            // manually update d.x to let simulation know x has changed
                            d.x = x;
                            return x
                        } else {
                            var x = width - ((xValObj[accessor(d)] = 1) * (radius * radiusMulti));
                            d.x = x;
                            return x
                        }
                    });
            barYaxisDOM = svg.append("g")
                    .attr("class", "y-axis").attr("transform","translate("+width+")")
                    .call(barYaxis);

            barYactive = true;
        }

        function barchartYRetweeted(filterFunction, accessor) {
            /* creates a bar chart on the left hand side from values (not a force function!) */
            removeForces();

            var barY = d3.scaleLinear()
                    .domain(d3.extent(data.filter(filterFunction), function(d) {
                        return +accessor(d) }))
                    .range([height, 0]);

            var barYaxis = d3.axisRight(barY);

            var xValObj = {};

            simulation.stop();

            radius = 3;

            if (width > height) {
                var radiusMulti = 3
            } else {
                var radiusMulti = 2
            }
            circles
                    .transition()
                    .duration(1500)
                    .attr("opacity", function(d) { return d.fade })
                    .attr("cy", function(d) {
                        for(var i = 0; i < 10;i++){
                            if(top10[i]){
                                continue
                            }
                            if(d.age == top10_data[i].age && top10.indexOf(d.screen_name) == -1){
                                top10[i] = d.screen_name;
                                d.location = top10_data[i].location;
                            }
                        }
                        var y = barY(+accessor(d));
                        // manually update d.y to let simulation know x has changed
                        d.y = y;
                        return d.y;
                    })
                    .attr("cx", function(d) {
                        if (xValObj[accessor(d)]) {
                            var x = width - ((xValObj[accessor(d)] += 1) * (radius * radiusMulti));
                            // manually update d.x to let simulation know x has changed
                            d.x = x;
                            return x
                        } else {
                            var x = width - ((xValObj[accessor(d)] = 1) * (radius * radiusMulti));
                            d.x = x;
                            return x
                        }
                    });
            var barY = d3.scaleLinear()
                    .domain(d3.extent(data.filter(filterFunction), function(d) {
                        return +accessor(d) }))
                    .range([height, 0]);

            var barYaxis = d3.axisRight(barY);

            var xValObj = {};
            circles.transition().duration(2000).attr("fill", function(d) { return getColor(d.location); })
                .attr("r", function (d) {
                if (top10_data != false){
                    return top10.indexOf(d.screen_name) != -1? 10 : radius;
                }else{
                    return radius;
                }}).attr("opacity", function (d) {
                if (top10_data != false){
                    return top10.indexOf(d.screen_name) != -1? 1 : 0.2;
                }else{
                    return 1;
                }}).transition().duration(2000).attr("cy", function(d) {
                for(var i = 0; i < 10;i++){
                    if(d.screen_name == top10[i]){
                        d.y = 30 * i;
                        return d.y;
                    }
                }
                var y = barY(+accessor(d));
                // manually update d.y to let simulation know x has changed
                d.y = y;
                return d.y;
                }).attr("cx", function(d) {
                        for(var i = 0; i < 10;i++){
                            if(d.screen_name == top10[i]){
                                d.x = width / 2 - 110;
                                return d.x;
                            }
                        }
                        if (xValObj[accessor(d)]) {
                            var x = width - ((xValObj[accessor(d)] += 1) * (radius * radiusMulti));
                            // manually update d.x to let simulation know x has changed
                            d.x = x;
                            return x
                        } else {
                            var x = width - ((xValObj[accessor(d)] = 1) * (radius * radiusMulti));
                            d.x = x;
                            return x
                        }
                    });
            addNames();
        }


        function getHashtags(name) {
            switch (name){
                case "Vote Leave":{
                    return "#VoteLeave"
                }
                case "LEAVE.EU":{
                    return "#VoteLeave"
                }
                case "TheOrdinaryMan":{
                    return "#Dictatorship"
                }
                case "Russ":{
                    return "#Remain"
                }
                case "Louise Mensch":{
                    return "#VoteLeave"
                }
                case "BBC News (UK)":{
                    return "#EURef"
                }
                case "Vote Leave Media":{
                    return "#VoteLeave"
                }
                case "Richard Branson":{
                    return "#VoteRemain"
                }
                case "J.K. Rowling":{
                    return "#Remain"
                }
                case "Emma Watson":{
                    return "#Remain"
                }
                case "Nick Reeves - 48%":{
                    return "#StopBrexit"
                }
                case "#Brexit Bin":{
                    return "#StopBrexit"
                }
                case "Craig Whitington":{
                    return "#Brexit (Leave)"
                }
                case "Richard Corbett":{
                    return "#LeaveLies"
                }
                case "UKIP Nonsense ❄":{
                    return "#StopBrexit"
                }
                case "James Melville":{
                    return "#FlorenceSpeech (Remain)"
                }
                case "Ebrahim Hemmatnia":{
                    return "#Iran"
                }
                case "Jeremy Cliffe": {
                    return "#FlorenceSpeech"
                }
                case "Mireia": {
                    return "#Catalunya+#Referèndum"
                }
                case "Graham Simpson":{
                    return "#StopBrexit"
                }

            }
        }

        function addNames() {
            var body = document.getElementById("background");
            var i = 0;
            top10_data.forEach(function (d) {
                var div = document.createElement("div");
                var text = document.createElement("p");
                text.innerText = "@"+d.name;
                div.style.position = "absolute";
                div.style.right = "23.5%";
                div.style.top = 30 + i * 30 +"px";
                div.style.color = "white";
                div.style.width = "26em";
                div.id = "div-"+i;
                text.style.display = "inline-block";
                text.style.fontSize = "1.8em";
                text.style.textAlign = "left";
                text.style.fontFamily = "proxima_nova_ltsemibold";
                var small_text = document.createElement("p");
                small_text.innerText = getHashtags(d.name);
                small_text.style.fontFamily = "proxima_nova_ltthin";
                small_text.style.display = "inline-block";
                small_text.style.marginLeft = "0.6em";
                div.appendChild(text);
                div.appendChild(small_text);
                i++;
                body.appendChild(div);
            })
        }
        function  removeNames() {
            for (var i = 0; i < 10; i++){
                document.getElementById("div-"+i).remove();
            }
        }

        function age(day) {

            var filterFunction = function(d) {
                return d.age != null
            };
            var accessor = function(d) {
                return d.age
            };
            if(day != ""){
                getMostInfluental(day,barchartYRetweeted,filterFunction,accessor);
            }else{
                barchartY(filterFunction,accessor)
            }
        }


        /* helper functions */

        function highlight(filterFunction) {
            data.forEach(function(d) {
                d.color = filterFunction(d) ? highlightColor : defaultColor
            })
        }
        function highlightCountries() {
            data.forEach(function(d) {
                d.color = d.position != false ? getColor(d.location) : "white"
            })
        }

        function fade(filterFunction) {
            data.forEach(function(d) {
                d.fade = filterFunction(d) ? 0 : 1
            })
        }

        function removeForces() {


            if (barYactive) {
                barYaxisDOM.remove();
                barYactive = false;
            }

            for (i=0; i<activeForces.length; i++) {
                simulation
                        .force(activeForces[i], null)
            }
            activeForces = [];
            simulation
                    .on("end", null);
        }


        function updateNodes() {
            circles
                    .transition()
                    .duration(updateDuration)
                    .attr("opacity", function(d) {
                        return d.fade
                    })
                    .attr("fill", function(d) {
                        return d.color
                    })
        }

        function getMostInfluental(day,callback,filterfunction,acessor){
            d3.csv("most_retweeted_"+day+".csv", function(error, data) {
                top10_data = data;
                data.forEach(function (d) {
                    d.age = Math.floor(d.age / 60 / 60 / 24 / 30);
                });
                callback(filterfunction,acessor)
            });
        }

        // from https://bl.ocks.org/mbostock/b1f0ee970299756bc12d60aedf53c13b

        function isolate(force, filter) {
            var initialize = force.initialize;
            force.initialize = function() { initialize.call(force, data.filter(filter)); };
            return force;
        }

        function ticked() {
            circles
                    .attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; })
        }
        function replaceData(s,callback) {
            d3.csv(s+"_brexit_data.csv", function(error, new_data) {
                new_data.forEach(
                        function (d) {
                            d.fade = 1;
                            d.color = defaultColor;
                            d.age = Math.floor(d.age / 60 / 60 / 24 / 30);
                            if (d.position == "" || typeof(d.position) == "undefined"){
                                d.position = false
                            }else{
                                var lat = Number(d.position.split(',')[0].split('(')[1]); //* Math.PI / 180;
                                var long = Number(d.position.split(',')[1].split(')')[0]); //* Math.PI / 180;
                                mapWidth    = divWidth;
                                mapHeight   = divHeight;
                                PI = Math.PI;
                                log = Math.log;
                                tan = Math.tan;
                                var x = (long+140)*(mapWidth/360);
                                // convert from degrees to radians
                                var latRad = lat*PI/180;
                                var mercN = log(tan((PI/4)+(latRad/2)));
                                y     = (mapHeight/2 - 7)-(mapWidth*mercN/(2*PI));
                                d.posy = y;
                                d.posx = x;
                            }
                        }
                );
//                svg.selectAll("g").remove();
                data = new_data;
                simulation
                        .nodes(data)
                        .on("tick", ticked);
                initSim();
                var circle = svg.selectAll("circle")
                        .data(data);

                circle.enter().append("circle")
                        .attr("r", radius);

                circle
                        .attr("cx", function(d) { return width / 2; })
                        .attr("r", radius)
                        .attr("cy", function(d) { return height / 2; });

                circle.exit().remove();
                baseSim(0.1);
                updateNodes();
            });
        }

        // draw circles

        var circles = svg.append("g")
                .attr("class", "circles")
                .selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("r", radius)
                .attr("opacity", 0.2)
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; })
                .attr("fill", function(d) {
                    d.color = defaultColor;
                    return d.color
                })
                .on("mouseover", function(d) {
                         console.log(d.location + " at " + d.posx + "," + d.posy)
                     });

        baseSim(0.1);
        updateNodes();


        // define trigger functions

        var triggerState;

        window._pre_trigger1 = function() {
            var filterIn = function(d) { return d.bogus == "False" && d.position != false};
            var filterOut = function(d) { return d.bogus == "False" && d.position == false };

            if (triggerState == "base") {

                highlight(filterOut);
                fade(filterOut);
                updateNodes();

                breakout(filterIn, filterOut)

            } else {
                if (triggerState != "breakout") {

                    highlight(filterOut);
                    fade(function(d) { return false });
                    updateNodes();

                    baseSim(0.6).on("end", function(d) {

                        highlight(filterOut);
                        fade(filterOut);
                        updateNodes();

                        breakout(filterIn, filterOut)
                    })
                }
            }
            fade(function (d) {
                return d.bogus == "False" && d.position == false;
            })
        };

        window._pre_trigger2 = function() {
            document.getElementById("background").style.background = "#000000";
            var filterIn = function(d) { return d.position != false};
            var filterOut = function(d) { return d.position == false };
            if (triggerState == "base") {
                highlight(filterOut);
                fade(filterOut);
                updateNodes();

                breakout(filterIn, filterOut)

            } else {
                if (triggerState != "breakout") {
                    highlight(filterOut);
                    fade(function(d) { return false });
                    updateNodes();

                    baseSim(0.6).on("end", function(d) {

                        highlight(filterOut);
                        fade(filterOut);
                        updateNodes();

                        breakout(filterIn, filterOut)
                    })
                }
            }
        };


        window._pre_trigger3 = function() {
            document.getElementById("background").style.background = "#000000 url('images/worldmap_1920.svg') no-repeat";
            fade(function(d) { return d.position == false });
            splitMap();
            highlightCountries();
            updateNodes()
        };

        window._pre_trigger4 = function() {
            top10_data = false;
            top10 = [false,false,false,false,false,false,false,false,false,false];
            document.getElementById("background").style.background = "#000000";
            highlight(function(d) { return false; });
            fade(function(d) { return false; });

            if (triggerState != "age") {
                updateNodes();
                baseSim(0.7).on("end", function() {
                    age("")
                })
            } else {
                age("")
            }
            triggerState = "age"

        };

        window._pre_trigger5 = function() {
            highlight(function(d) { return false});
            fade(function(d) { return false });

            if (triggerState != "age") {
                triggerState = "age"
            }
            age("pre")

        };

        window._post_trigger1 = function () {
            removeNames();
            replaceData("post",baseSim);
            triggerState = "base";
        };
        window._post_trigger2 = function() {
            var filterIn = function(d) { return d.bogus == "False" && d.position != false};
            var filterOut = function(d) { return d.bogus == "False" && d.position == false };

            if (triggerState == "base") {

                highlight(filterOut);
                fade(filterOut);
                updateNodes();

                breakout(filterIn, filterOut)

            } else {
                if (triggerState != "breakout") {

                    highlight(filterOut);
                    fade(function(d) { return false });
                    updateNodes();

                    baseSim(0.6).on("end", function(d) {

                        highlight(filterOut);
                        fade(filterOut);
                        updateNodes();

                        breakout(filterIn, filterOut)
                    })
                }
            }
            fade(function (d) {
                return d.bogus == "False" && d.position == false;
            })
        };

        window._post_trigger3 = function() {
            document.getElementById("background").style.background = "#000000";
            var filterIn = function(d) { return d.position != false};
            var filterOut = function(d) { return d.position == false };
            if (triggerState == "base") {
                highlight(filterOut);
                fade(filterOut);
                updateNodes();

                breakout(filterIn, filterOut)

            } else {
                if (triggerState != "breakout") {
                    highlight(filterOut);
                    fade(function(d) { return false });
                    updateNodes();

                    baseSim(0.6).on("end", function(d) {

                        highlight(filterOut);
                        fade(filterOut);
                        updateNodes();

                        breakout(filterIn, filterOut)
                    })
                }
            }
        };


        window._post_trigger4 = function() {
            document.getElementById("background").style.background = "#000000 url('images/worldmap_1920.svg') no-repeat";
            fade(function(d) { return d.position == false });
            splitMap();
            highlightCountries();
            updateNodes()
        };

        window._post_trigger5 = function() {
            top10_data = false;
            top10 = [false,false,false,false,false,false,false,false,false,false];
            document.getElementById("background").style.background = "#000000";
            highlight(function(d) { return false; });
            fade(function(d) { return false; });

            if (triggerState != "age") {
                updateNodes();
                baseSim(0.7).on("end", function() {
                    age("")
                })
            } else {
                age("")
            }
            triggerState = "age"

        };
        window._post_trigger6 = function() {
            highlight(function(d) { return false; });
            fade(function(d) { return false; });

            if (triggerState != "age") {
                updateNodes();
                baseSim(0.7).on("end", function() {
                    age("post")
                })
            } else {
                age("post")
            }
            triggerState = "age"

        };

        var triggers = [window._pre_trigger1, window._pre_trigger2,window._pre_trigger3,window._pre_trigger4, window._pre_trigger5,
            window._post_trigger1,window._post_trigger2,window._post_trigger3,window._post_trigger4,window._post_trigger5,window._post_trigger6];

        var navCount = -1;

        d3.select("#left")
                .on("click", function() {
                    navCount -= 1;
                    triggers[navCount]();
                    console.log(navCount)
                });

        d3.select("#right")
                .on("click", function() {
                    navCount += 1;
                    triggers[navCount]();
                    console.log(navCount)
                });


        // window._vizData = data
        window._triggerRandom = function() {
            triggers[Math.floor(Math.random() * triggers.length)]()
        }
    });


</script>
</body>

</html>
