<!DOCTYPE html>
<!--Created by SVT:s Quickshot team: https://www.svt.se/pejl/-->
<meta charset="utf-8">
<head>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link rel="stylesheet" type="text/css" href="fonts/fonts.min.css" />
    <style>
        body {
            font-family: 'proxima_nova_ltsemibold',Georgia, sans-serif;
            background: #000000;
            color: #ffffff;
        }
        #title{
            margin: auto;
            width: 50%;
            text-align: justify;
            padding: 10px;
            position: absolute;
            left: 25%;
        }
        h1{
            font-size: 3em;
        }
        #title h1{
            text-align: center;
        }
        #title p{
            font-size: 1.5em;
            font-family: 'proxima_nova_ltthin',Georgia, sans-serif;
        }
        #text{
            visibility: hidden;
            position: absolute;
            width: 466px;
            height: 230px;
            top: 390px;
            left: 0;
            z-index: 1;
            background-color: rgba(0,0,0,0.7);
        }
        #text p {
            margin-left: 1.5em;
            margin-right: 1.5em;
            text-align: right;
        }
        #viz {
            width: 100%;
            height: 700px;
        }
        .y-axis line {
            stroke: white;
        }
        .y-axis path {
            stroke: white;
        }
        .y-axis text {
            fill: white;
        }


    </style>
</head>

<body id="background">
<div id="title"><h1>What does Twitter have to say about Brexit?</h1>
<p>This data set comes from the Neuropolitics Research Lab at the University of Edinburgh, a transdisciplinary research centre that utilises developments in cognitive neurosciences to shed light on new political attitudes, identities and behaviours. Their aim with providing this large data set was to provide new insights into how citizens’ Brexit-related expectations are shaped in a digital world. How have their expectations about Brexit changed? Have their expectations changed from when they voted? What are the perceptions of digital authenticity and trust?
    <br><br>
    Brexit-related Tweets in this visualisation come from the following days:
    Pre-Referendum (21-22 June 2016)
    Referendum (23 June 2016)
    Post- Referendum (22-23 September 2017, Florence Speech)</p></div>
<div id="text">
    <p id="text-p">Eine wunderbare Heiterkeit hat meine ganze Seele eingenommen, gleich den süßen Frühlingsmorgen, die ich mit ganzem Herzen genieße. Ich bin allein und freue mich meines
    </p>
</div>
<div id="viz"></div>
<button id="left"><</button>
<button id="right">></button>

<script>

    Element.prototype.remove = function() {
        this.parentElement.removeChild(this);
    };
    NodeList.prototype.remove = HTMLCollection.prototype.remove = function() {
        for(var i = this.length - 1; i >= 0; i--) {
            if(this[i] && this[i].parentElement) {
                this[i].parentElement.removeChild(this[i]);
            }
        }
    };

    // get width and height from viz-div

    var divWidth = document.getElementById("viz").clientWidth;
    var divHeight = document.getElementById("viz").clientHeight;

    var height = 700;
    var width = 1219;

    var margin = {top: height*0.1, right: width * 0.08, bottom: height * 0.06, left: width * 0.08};

    width = width - margin.left - margin.right;
    height = height - margin.top - margin.bottom;


    var svg = d3.select("#viz").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("class", "chart")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var background = svg.append("rect")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("transform", "translate(" + (-margin.left) + "," + (-margin.top) + ")")
            .attr("fill", "transparent");


    var radius = 3;

    var defaultColor = "white";

    var highlightColor = "grey";

    var updateDuration = 1500;

    var activeForces = [];

    var barYactive = false;

    var top10_data = false;
    var top10 = [false,false,false,false,false,false,false,false,false,false];
    d3.csv("during_brexit_data.csv", function(error, data) {
        if (error) throw error;

        data.forEach(function(d) {
            d.fade = 1;
            d.color = defaultColor;
            d.age = Math.floor(d.age / 60 / 60 / 24 / 30);
            if (d.position == ""){
                d.position = false
            }else{
                var lat = Number(d.position.split(',')[0].split('(')[1]); //* Math.PI / 180;
                var long = Number(d.position.split(',')[1].split(')')[0]); //* Math.PI / 180;
                var mapWidth    = divWidth;
                var mapHeight   = divHeight;
                var PI = Math.PI;
                var log = Math.log;
                var tan = Math.tan;
                //166
                var x = (long+180 - (mapWidth/30.473))*(mapWidth/360);
                // convert from degrees to radians
                var latRad = lat*PI/180;
                var mercN = log(tan((PI/4)+(latRad/2)));
                d.posy = (mapHeight/2 - 7)-(mapWidth*mercN/(2*PI));
                d.posx = x;
            }
        });

        /* scales */

        var randomX = d3.scaleLinear()
                .domain([0, 1])
                .range([0, width-radius]);

        var randomY = d3.scaleLinear()
                .domain([0, 1])
                .range([0, height-radius]);

        /* define and init simulation */

        var simulation = d3.forceSimulation();

        simulation
                .nodes(data)
                .on("tick", ticked);


        initSim();
        /* basic simulation functions */

        function initSim() {
            simulation
                    .force("x", d3.forceX(function() {
                        return randomX(Math.random())
                    }))
                    .force("y", d3.forceY(function() {
                        return randomY(Math.random())
                    }))
                    .alphaMin(0.5)
                    .stop();
            // loop through simulation ticks to land in a stable state with randomly distributed nodes
            for (var i = 0; i < 100; ++i) simulation.tick()

            activeForces.push("x", "y");

            return simulation
        }

        function getColor(location){
            var lat = Number(location.split(',')[0].split('(')[1]);
            var long = Number(location.split(',')[1].split(')')[0]);
            if(lat < -24 && long > 110){
                return "#ff6633"
            }
            if(lat > -8 && long > 50){
                return "#ccff66";
            }
            if (lat < 32 && long > 3){
                return "#996666";
            }

            if(lat > 0 && long > -10){
                return "#3366cc";
            }else{
                return "#CC33FF";
            }

//            var country = "";
//            if(location.indexOf(',') != -1){
//               country = location.split(",")[1].substr(1)
//            }else{
//                country = location
//            }
//            switch (country){
//                case "United Kingdom":
//                case "England":
//                case "Wales":
//                case "Scotland":
//                case "France":
//                case "Germany":
//                case "Spain":
//                case "Ireland":
//                case "Belgium":
//                case "Netherlands":
//                case "Italy":
//                case "Sweden":
//                case "Greece":
//                case "Poland":
//                case "Catalunya":
//                case "Denmark":
//                    return "#3366cc";
//                case "United States":
//                case "Canada":
//                case "Mexico":
//                    return "#CC33FF";
//                case "India":
//                case "Singapore":
//                case "Thailand":
//                case "China":
//                case "UAE":
//                    return "#ccff66";
//                case "Australia":
//                    return "#ff6633";
//                case "South Africa":
//                case "Nigeria":
//                    return "#996666";
//                default:
//                    return "#FFFFFF"
//            }

        }


        function baseSim(alphaMin) {
            /* creates basic petri dish of nodes */

            removeForces();
            radius = 1;

            simulation
                    .stop()
                    .force("charge", d3.forceManyBody().strength(-2))
                    .force("x", d3.forceX(width/4 * 3).strength(0.12))
                    .force("y", d3.forceY(height/2).strength(0.12))
                    .force("collide", d3.forceCollide(radius))
                    .alphaMin(alphaMin)
                    .alpha(1)
                    .restart();
            activeForces.push("charge", "x", "y", "collide");


            return simulation

        }


        function breakdownMap(breakdownObjects) {
            /* breaks down nodes into groups centers of gravity defined by x and y functions */

            var radius = 0.5;

            removeForces();

            for (var i=0; i<breakdownObjects.length; i++) {
                switch(breakdownObjects[i]["type"]) {

                    case "xy":
                        var customX = d3.forceX(breakdownObjects[i]["breakX"]).strength(breakdownObjects[i]["strengthX"]);
                        var customY = d3.forceY(breakdownObjects[i]["breakY"]).strength(breakdownObjects[i]["strengthY"]);


                        simulation
                                .force("x" + i.toString(), customX)
                                .force("y" + i.toString(), customY);
                        activeForces.push("x" + i.toString());
                        activeForces.push("y" + i.toString());

                        break;

                    case "charge":
                       // var customCharge = isolate(d3.forceManyBody(), breakdownObjects[i]["filter"]).strength(breakdownObjects[i]["strength"])
                       // simulation
                       //         .force("charge" + i.toString(), customCharge);
                       // activeForces.push("charge" + i.toString());

                        break;
                }
            }

            simulation
                    .force("collide", d3.forceCollide(radius))
                    .alpha(1)
                    .alphaMin(0.4)
                    .restart();

            activeForces.push("collide");


            return simulation
        }

        function breakout(filterIn, filterOut) {
            /* breakout a selection of nodes by lifting them out from petri dish to a radial circle and fading out the non-selected nodes */

            removeForces();

            var customRadial = isolate(d3.forceRadial(width * 0.7, width / 4 * 3, height / 2), filterOut).strength(0.12);


            var customCenter = isolate(d3.forceCenter(width / 4 * 3, height / 2), filterIn);

            simulation.stop()
                    .force("center", customCenter)
                    .force("radial", customRadial)
                    .force("collide", d3.forceCollide(radius))
                    .alpha(1)
                    .alphaMin(0.6)
                    .restart()
                    .on("end", null);

            activeForces.push("center", "radial", "collide");


            return simulation

        }
        function splitMap(){
            var xFunction = function(d) {
                return d.position? d.posx : 0
            };
            var yFunction = function(d) {
                return d.position? d.posy : 0
            };

            var breakdownObjs = [{"type": "xy", "breakX": xFunction, "strengthX": 0.15, "breakY": yFunction, "strengthY": 0.15}, {"type": "charge", "filter": function(d) { return d; },"strength": -1.5}];

            breakdownMap(breakdownObjs)
        }

        var barYaxisDOM; // defined here in order to be accessible for removal by resetForces function

        function barchartY(filterFunction, accessor) {
            /* creates a bar chart on the left hand side from values (not a force function!) */
            removeForces();

            var barY = d3.scaleLinear()
                    .domain(d3.extent(data.filter(filterFunction), function(d) {
                        return +accessor(d) }))
                    .range([height, 0]);

            var barYaxis = d3.axisRight(barY);

            var xValObj = {};

            simulation.stop();

            radius = 3;
            var radiusMulti;
            if (width > height) {
                radiusMulti = 3
            } else {
                radiusMulti = 2
            }
            circles
                    .transition()
                    .duration(1500)
                    .attr("opacity", function(d) { return d.fade })
                    .attr("fill", function(d) { return d.position != false ? getColor(d.position) : "white"})
                    .attr("cy", function(d) {
                        // manually update d.x to let simulation know x has changed
                        d.y = barY(+accessor(d));
                        return d.y;
                    })
                    .attr("cx", function(d) {
                        if (xValObj[accessor(d)]) {
                            // manually update d.x to let simulation know x has changed
                            d.x = width - ((xValObj[accessor(d)] += 1) * (radius * radiusMulti));
                            return d.x
                        } else {
                            d.x = width - ((xValObj[accessor(d)] = 1) * (radius * radiusMulti));
                            return d.x
                        }
                    });
            barYaxisDOM = svg.append("g")
                    .attr("class", "y-axis").attr("transform","translate("+width+")")
                    .call(barYaxis);

            barYactive = true;
        }

        function barchartYRetweeted(filterFunction, accessor) {
            /* creates a bar chart on the left hand side from values (not a force function!) */
            removeForces();

            var barY = d3.scaleLinear()
                    .domain(d3.extent(data.filter(filterFunction), function(d) {
                        return +accessor(d) }))
                    .range([height, 0]);

            var xValObj = {};

            simulation.stop();

            radius = 3;
            var radiusMulti;
            if (width > height) {
                radiusMulti = 3
            } else {
                radiusMulti = 2
            }
            circles
                    .transition()
                    .duration(1500)
                    .attr("opacity", function(d) { return d.fade })
                    .attr("cy", function(d) {
                        for(var i = 0; i < 10;i++){
                            if(top10[i]){
                                continue
                            }
                            if(d.age == top10_data[i].age && top10.indexOf(d.screen_name) == -1){
                                top10[i] = d.screen_name;
                                d.location = top10_data[i].location;
                            }
                        }
                        // manually update d.y to let simulation know x has changed
                        d.y = barY(+accessor(d));
                        return d.y;
                    })
                    .attr("cx", function(d) {
                        if (xValObj[accessor(d)]) {
                            // manually update d.x to let simulation know x has changed
                            d.x = width - ((xValObj[accessor(d)] += 1) * (radius * radiusMulti));
                            return d.x
                        } else {
                            d.x = width - ((xValObj[accessor(d)] = 1) * (radius * radiusMulti));
                            return d.x
                        }
                    });
            var xValObj_2 = {};
            circles.transition().duration(2000).attr("fill", function(d) { return d.position != false ? getColor(d.position) : "white"})
                .attr("r", function (d) {
                if (top10_data != false){
                    return top10.indexOf(d.screen_name) != -1? 10 : radius;
                }else{
                    return radius;
                }}).attr("opacity", function (d) {
                if (top10_data != false){
                    return top10.indexOf(d.screen_name) != -1? 1 : 0.2;
                }else{
                    return 1;
                }}).transition().duration(2000).attr("cy", function(d) {
                for(var i = 0; i < 10;i++){
                    if(d.screen_name == top10[i]){
                        d.y = 30 * i;
                        return d.y;
                    }
                }
                // manually update d.y to let simulation know x has changed
                d.y = barY(+accessor(d));
                return d.y;
                }).attr("cx", function(d) {
                        for(var i = 0; i < 10;i++){
                            if(d.screen_name == top10[i]){
                                d.x = width / 2 - 110;
                                return d.x;
                            }
                        }
                        if (xValObj_2[accessor(d)]) {
                            // manually update d.x to let simulation know x has changed
                            d.x = width - ((xValObj_2[accessor(d)] += 1) * (radius * radiusMulti));
                            return d.x
                        } else {
                            d.x = width - ((xValObj_2[accessor(d)] = 1) * (radius * radiusMulti));
                            return d.x
                        }
                    });
            addNames();
        }


        function getHashtags(name) {
            switch (name){
                case "Vote Leave":{
                    return "#VoteLeave"
                }
                case "LEAVE.EU":{
                    return "#VoteLeave"
                }
                case "TheOrdinaryMan":{
                    return "#Dictatorship"
                }
                case "Russ":{
                    return "#Remain"
                }
                case "Louise Mensch":{
                    return "#VoteLeave"
                }
                case "BBC News (UK)":{
                    return "#EURef"
                }
                case "Vote Leave Media":{
                    return "#VoteLeave"
                }
                case "Richard Branson":{
                    return "#VoteRemain"
                }
                case "J.K. Rowling":{
                    return "#Remain"
                }
                case "Emma Watson":{
                    return "#Remain"
                }
                case "Nick Reeves - 48%":{
                    return "#StopBrexit"
                }
                case "#Brexit Bin":{
                    return "#StopBrexit"
                }
                case "Craig Whitington":{
                    return "#Brexit (Leave)"
                }
                case "Richard Corbett":{
                    return "#LeaveLies"
                }
                case "UKIP Nonsense ❄":{
                    return "#StopBrexit"
                }
                case "James Melville":{
                    return "#FlorenceSpeech (Remain)"
                }
                case "Ebrahim Hemmatnia":{
                    return "#Iran"
                }
                case "Jeremy Cliffe": {
                    return "#FlorenceSpeech"
                }
                case "Mireia": {
                    return "#Catalunya+#Referèndum"
                }
                case "Graham Simpson":{
                    return "#StopBrexit"
                }
                case "Stronger In":{
                    return "#Remain"
                }
                case "graham norton":{
                    return "#remain"
                }
                case "Mis Standen":{
                    return "#EUisTheProblem"
                }
                case "Andrea Leadsom MP‏":{
                    return "#IndependenceDay"
                }
                case "Bloomberg":{
                    return "#Brexit"
                }
                case "Bonnie Greer":{
                    return "#Remain"
                }
                case "David Peterson":{
                    return "#VoteLeave"
                }
                case "RT":{
                    return "#Brexit (Leave)"
                }
                default:{
                    return "#IndependenceDay"
                }


            }
        }
        var NameState = 0;
        function addNames() {
            var body = document.getElementById("background");
            var i = 0;
            top10_data.forEach(function (d) {
                var div = document.createElement("div");
                var text = document.createElement("p");
                text.innerText = "@"+d.name;
                div.style.position = "absolute";
                div.style.right = "21.1%";
                div.style.top = 30 + i * 30 +"px";
                div.style.color = "white";
                div.style.width = "28em";
                div.id ="div-"+i;
                div.classList.add("divs-"+NameState);
                text.style.display = "inline-block";
                text.style.fontSize = "1.8em";
                text.style.textAlign = "left";
                text.style.fontFamily = "proxima_nova_ltsemibold";
                var small_text = document.createElement("p");
                small_text.innerText = getHashtags(d.name);
                small_text.style.fontFamily = "proxima_nova_ltthin";
                small_text.style.display = "inline-block";
                small_text.style.marginLeft = "0.6em";
                div.appendChild(text);
                div.appendChild(small_text);
                i++;
                body.appendChild(div);
            });
            NameState++
        }
        function  removeNames() {
            [].forEach.call(document.getElementsByClassName("divs-"+(NameState-1)), function (el) {
                el.style.visibility = "hidden"
            });
        }
        function removeTitlePage() {
            document.getElementById("title").remove();
        }
        function addEndPage(){
            var getHashtagColor = function (innerText) {
                switch (innerText){
                    case "#VoteLeave":
                    case "#Dictatorship":
                    case "#IndependenceDay":
                    case "#EUisTheProblem":
                    case "#Brexit (Leave)":{
                        return "red"
                    }
                    case "#VoteRemain":
                    case "#Remain":
                    case "#remain":
                    case "#StopBrexit":
                    case "#LeaveLies":
                    case "#FlorenceSpeech (Remain)":
                    case "VoteRemain":{
                        return "#98FB98"
                    }
                    default:
                        return "white"
                }
            };
            [].forEach.call(document.getElementsByClassName("divs-0"), function (el) {
                el.style.visibility = "visible";
                el.style.right = "63%";
                el.style.color = getHashtagColor(el.childNodes[1].innerText);
            });
            [].forEach.call(document.getElementsByClassName("divs-1"), function (el) {
                el.style.visibility = "visible";
                el.style.right = "-5%";
                el.style.color = getHashtagColor(el.childNodes[1].innerText);
            });
            [].forEach.call(document.getElementsByClassName("divs-2"), function (el) {
                el.style.visibility = "visible";
                el.style.right = "28.5%";
                el.style.color = getHashtagColor(el.childNodes[1].innerText);
            });
            document.getElementById("text").style.left = "30%";
            document.getElementById("text-p").style.textAlign = "justify";

        }
        function age(day) {

            var filterFunction = function(d) {
                return d.age != null
            };
            var accessor = function(d) {
                return d.age
            };
            if(day != ""){
                getMostInfluental(day,barchartYRetweeted,filterFunction,accessor);
            }else{
                barchartY(filterFunction,accessor)
            }
        }


        /* helper functions */

        function highlight(filterFunction) {
            data.forEach(function(d) {
                d.color = filterFunction(d) ? highlightColor : defaultColor
            })
        }
        function highlightCountries() {
            data.forEach(function(d) {
                d.color = d.position != false ? getColor(d.position) : "white"
            })
        }

        function fade(filterFunction) {
            data.forEach(function(d) {
                d.fade = filterFunction(d) ? 0 : 1
            })
        }

        function removeForces() {


            if (barYactive) {
                barYaxisDOM.remove();
                barYactive = false;
            }

            for (var i=0; i<activeForces.length; i++) {
                simulation
                        .force(activeForces[i], null)
            }
            activeForces = [];
            simulation
                    .on("end", null);
        }


        function updateNodes() {
            circles
                    .transition()
                    .duration(updateDuration)
                    .attr("opacity", function(d) {
                        return d.fade
                    })
                    .attr("fill", function(d) {
                        return d.color
                    })
        }

        function getMostInfluental(day,callback,filterfunction,acessor){
            d3.csv("most_retweeted_"+day+".csv", function(error, data) {
                top10_data = data;
                data.forEach(function (d) {
                    d.age = Math.floor(d.age / 60 / 60 / 24 / 30);
                });
                callback(filterfunction,acessor)
            });
        }

        // from https://bl.ocks.org/mbostock/b1f0ee970299756bc12d60aedf53c13b

        function isolate(force, filter) {
            var initialize = force.initialize;
            force.initialize = function() { initialize.call(force, data.filter(filter)); };
            return force;
        }

        function ticked() {
            circles
                    .attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; })
        }
        function setText(text){
            var text_block = document.getElementById('text-p');
            document.getElementById('text').style.visibility = "visible";
            text_block.style.visibility = "visible";
            text_block.innerText = text;
        }
        function setHeading(heading){
            var text_heading = document.getElementById('heading');
            text_heading.style.visibility = "visible";
            text_heading.innerText = heading;
        }

        function replaceData(s,callback) {
            d3.csv(s+"_brexit_data.csv", function(error, new_data) {
                new_data.forEach(
                        function (d) {
                            d.fade = 1;
                            d.color = defaultColor;
                            d.age = Math.floor(d.age / 60 / 60 / 24 / 30);
                            if (d.position == "" || typeof(d.position) == "undefined"){
                                d.position = false
                            }else{
                                var lat = Number(d.position.split(',')[0].split('(')[1]); //* Math.PI / 180;
                                var long = Number(d.position.split(',')[1].split(')')[0]); //* Math.PI / 180;
                                mapWidth    = divWidth;
                                mapHeight   = divHeight;
                                PI = Math.PI;
                                log = Math.log;
                                tan = Math.tan;
                                var x = (long+140)*(mapWidth/360);
                                // convert from degrees to radians
                                var latRad = lat*PI/180;
                                var mercN = log(tan((PI/4)+(latRad/2)));
                                y     = (mapHeight/2 - 7)-(mapWidth*mercN/(2*PI));
                                d.posy = y;
                                d.posx = x;
                            }
                        }
                );
//                svg.selectAll("g").remove();
                data = new_data;
                simulation
                        .nodes(data)
                        .on("tick", ticked);
                initSim();
                var circle = svg.selectAll("circle")
                        .data(data);

                circle.enter().append("circle")
                        .attr("r", radius);

                circle
                        .attr("cx", function(d) { return width / 4 * 3; })
                        .attr("r", radius)
                        .attr("cy", function(d) { return height / 2; });

                circle.exit().remove();
                baseSim(0.1);
                updateNodes();
            });
        }


        // define trigger functions

        var triggerState;
        var circles;


        window._pre_trigger0 = function () {
            removeNames();
            replaceData("pre",baseSim);
            triggerState = "base";
            setText("These are all Twitter accounts posting about Brexit before the referendum.");
        };

        window._pre_trigger1 = function() {
            var filterIn = function(d) { return d.bogus == "False" && d.position != false};
            var filterOut = function(d) { return d.bogus == "False" && d.position == false };

            if (triggerState == "base") {

                highlight(filterOut);
                fade(filterOut);
                updateNodes();

                breakout(filterIn, filterOut)

            } else {
                if (triggerState != "breakout") {

                    highlight(filterOut);
                    fade(function(d) { return false });
                    updateNodes();

                    baseSim(0.6).on("end", function(d) {

                        highlight(filterOut);
                        fade(filterOut);
                        updateNodes();

                        breakout(filterIn, filterOut)
                    })
                }
            }
            fade(function (d) {
                return d.bogus == "False" && d.position == false;
            });
            setText("For this instance, we eliminated all users that did not list a location on their profile.");
        };

        window._pre_trigger2 = function() {
            document.getElementById("background").style.background = "#000000";
            var filterIn = function(d) { return d.position != false};
            var filterOut = function(d) { return d.position == false };
            if (triggerState == "base") {
                highlight(filterOut);
                fade(filterOut);
                updateNodes();

                breakout(filterIn, filterOut)

            } else {
                if (triggerState != "breakout") {
                    highlight(filterOut);
                    fade(function(d) { return false });
                    updateNodes();

                    baseSim(0.6).on("end", function(d) {

                        highlight(filterOut);
                        fade(filterOut);
                        updateNodes();

                        breakout(filterIn, filterOut)
                    })
                }
            }
            setText("We then removed all users with unrecognisable locations.")
        };


        window._pre_trigger3 = function() {
            document.getElementById("background").style.background = "#000000 url('images/worldmap_1920.svg') no-repeat";
            fade(function(d) { return d.position == false });
            splitMap();
            highlightCountries();
            updateNodes();
            setText("Here we can visualise all users with a validated location. The majority are located in Europe and North America, however there are a few outliers in other parts of the world.")
        };

        window._pre_trigger4 = function() {
            top10_data = false;
            top10 = [false,false,false,false,false,false,false,false,false,false];
            document.getElementById("background").style.background = "#000000";
            highlight(function(d) { return false; });
            fade(function(d) { return false; });

            if (triggerState != "age") {
                updateNodes();
                baseSim(0.7).on("end", function() {
                    age("")
                })
            } else {
                age("")
            }
            triggerState = "age";
            setText("Using the whole sample of users, we now re-arrange them according to account creation date. A large number of accounts were created the same day they tweeted (0 months).")
        };

        window._pre_trigger5 = function() {
            highlight(function(d) { return false});
            fade(function(d) { return false });

            if (triggerState != "age") {
                triggerState = "age"
            }
            age("pre");
            setText("The top ten biggest influencers, the most retweeted users, varied in message. However, the top two were pro-Brexit and their accounts were recently created.")
        };

        window._during_trigger1 = function(){
            removeTitlePage();
            // draw circles
            circles = svg.append("g")
                    .attr("class", "circles")
                    .selectAll("circle")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("r", radius)
                    .attr("opacity", 0.2)
                    .attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; })
                    .attr("fill", function(d) {
                        d.color = defaultColor;
                        return d.color
                    })
                    .on("mouseover", function(d) {
                        console.log(d.location + " at " + d.position)
                    });

            baseSim(0.1);
            updateNodes();
            setText("These are all Twitter accounts posting about Brexit during the referendum. This is our largest data set with over half a million accounts.  Each dot represents 100 user accounts.")
        };

        window._during_trigger2 = function() {
            var filterIn = function(d) { return d.bogus == "False" && d.position != false};
            var filterOut = function(d) { return d.bogus == "False" && d.position == false };

            if (triggerState == "base") {

                highlight(filterOut);
                fade(filterOut);
                updateNodes();

                breakout(filterIn, filterOut)

            } else {
                if (triggerState != "breakout") {

                    highlight(filterOut);
                    fade(function(d) { return false });
                    updateNodes();

                    baseSim(0.6).on("end", function(d) {

                        highlight(filterOut);
                        fade(filterOut);
                        updateNodes();

                        breakout(filterIn, filterOut)
                    })
                }
            }
            fade(function (d) {
                return d.bogus == "False" && d.position == false;
            });
            setText("We eliminated all users that did not list a location on their profile.")
        };

        window._during_trigger3 = function() {
            document.getElementById("background").style.background = "#000000";
            var filterIn = function(d) { return d.position != false};
            var filterOut = function(d) { return d.position == false };
            if (triggerState == "base") {
                highlight(filterOut);
                fade(filterOut);
                updateNodes();

                breakout(filterIn, filterOut)

            } else {
                if (triggerState != "breakout") {
                    highlight(filterOut);
                    fade(function(d) { return false });
                    updateNodes();

                    baseSim(0.6).on("end", function(d) {

                        highlight(filterOut);
                        fade(filterOut);
                        updateNodes();

                        breakout(filterIn, filterOut)
                    })
                }
            }
            setText("We removed all users with unrecognisable locations.")
        };


        window._during_trigger4 = function() {
            document.getElementById("background").style.background = "#000000 url('images/worldmap_1920.svg') no-repeat";
            fade(function(d) { return d.position == false });
            splitMap();
            highlightCountries();
            updateNodes();
            setText("Here we can visualise all users with a validated location. There are more represented locations in this set, thus showing how active Twitter was during the referendum. ")
        };

        window._during_trigger5 = function() {
            top10_data = false;
            top10 = [false,false,false,false,false,false,false,false,false,false];
            document.getElementById("background").style.background = "#000000";
            highlight(function(d) { return false; });
            fade(function(d) { return false; });

            if (triggerState != "age") {
                updateNodes();
                baseSim(0.7).on("end", function() {
                    age("")
                })
            } else {
                age("")
            }
            triggerState = "age";
            setText("Like pre-referendum, the majority of the accounts tweeting were created in the same day that they tweeted. ")

        };
        window._during_trigger6 = function() {
            highlight(function(d) { return false; });
            fade(function(d) { return false; });

            if (triggerState != "age") {
                updateNodes();
                baseSim(0.7).on("end", function() {
                    age("during")
                })
            } else {
                age("during")
            }
            triggerState = "age";
            setText("XXXX")
        };

        window._post_trigger1 = function () {
            removeNames();
            replaceData("post",baseSim);
            triggerState = "base";
            setText("These are all Twitter accounts posting about Brexit after the referendum, during the Florence Speech. ")
        };
        window._post_trigger2 = function() {
            var filterIn = function(d) { return d.bogus == "False" && d.position != false};
            var filterOut = function(d) { return d.bogus == "False" && d.position == false };

            if (triggerState == "base") {

                highlight(filterOut);
                fade(filterOut);
                updateNodes();

                breakout(filterIn, filterOut)

            } else {
                if (triggerState != "breakout") {

                    highlight(filterOut);
                    fade(function(d) { return false });
                    updateNodes();

                    baseSim(0.6).on("end", function(d) {

                        highlight(filterOut);
                        fade(filterOut);
                        updateNodes();

                        breakout(filterIn, filterOut)
                    })
                }
            }
            fade(function (d) {
                return d.bogus == "False" && d.position == false;
            });
            setText("Once again, we eliminated all users that did not list a location on their profile.")
        };

        window._post_trigger3 = function() {
            document.getElementById("background").style.background = "#000000";
            var filterIn = function(d) { return d.position != false};
            var filterOut = function(d) { return d.position == false };
            if (triggerState == "base") {
                highlight(filterOut);
                fade(filterOut);
                updateNodes();

                breakout(filterIn, filterOut)

            } else {
                if (triggerState != "breakout") {
                    highlight(filterOut);
                    fade(function(d) { return false });
                    updateNodes();

                    baseSim(0.6).on("end", function(d) {

                        highlight(filterOut);
                        fade(filterOut);
                        updateNodes();

                        breakout(filterIn, filterOut)
                    })
                }
            }
            setText("We then removed all users with unrecognisable locations.")
        };


        window._post_trigger4 = function() {
            document.getElementById("background").style.background = "#000000 url('images/worldmap_1920.svg') no-repeat";
            fade(function(d) { return d.position == false });
            splitMap();
            highlightCountries();
            updateNodes();
            setText("Here we can visualise all users with a validated location. The majority are located in Europe and in this case, the outliers are in North America.")
        };

        window._post_trigger5 = function() {
            top10_data = false;
            top10 = [false,false,false,false,false,false,false,false,false,false];
            document.getElementById("background").style.background = "#000000";
            highlight(function(d) { return false; });
            fade(function(d) { return false; });

            if (triggerState != "age") {
                updateNodes();
                baseSim(0.7).on("end", function() {
                    age("")
                })
            } else {
                age("")
            }
            triggerState = "age";
            setText("Using the whole sample of users, we now re-arrange them according to account creation date. We can now see a more even distribution of account creation dates.")

        };
        window._post_trigger6 = function() {
            highlight(function(d) { return false; });
            fade(function(d) { return false; });

            if (triggerState != "age") {
                updateNodes();
                baseSim(0.7).on("end", function() {
                    age("post")
                })
            } else {
                age("post")
            }
            triggerState = "age";
            setText("The top ten biggest influencers have now shifted. The top two are now anti-Brexit, as is the majority in this list.")

        };
        window._trigger_final = function () {
            circles.transition().duration(2000).attr('opacity',0);
            addEndPage();
            setText("Across all data sets, a large majority of accounts were created on the same day they were tweeting. The biggest influencers were pro-Brexit and we hypothesize many of their accounts were solely created for campaign purposes, rather than “real” users expressing their opinions. We also wonder if the leave-campaigners were substantially more active on Twitter, rather than remain-backers, thus influencing public opinion on a large scale. A year after the referendum, the biggest influencers have shifted, and now users on Twitter favour a remain position")

        };
        var triggers = [window._during_trigger1,window._during_trigger2,window._during_trigger3,window._during_trigger4,window._during_trigger5,window._during_trigger6,
            window._pre_trigger0,window._pre_trigger1, window._pre_trigger2,window._pre_trigger3,window._pre_trigger4, window._pre_trigger5,
            window._post_trigger1,window._post_trigger2,window._post_trigger3,window._post_trigger4,window._post_trigger5,window._post_trigger6,window._trigger_final];

        var navCount = -1;

        d3.select("#left")
                .on("click", function() {
                    navCount -= 1;
                    triggers[navCount]();
                    console.log(navCount)
                });

        d3.select("#right")
                .on("click", function() {
                    navCount += 1;
                    triggers[navCount]();
                    console.log(triggers[navCount])
                });


        // window._vizData = data
        window._triggerRandom = function() {
            triggers[Math.floor(Math.random() * triggers.length)]()
        }
    });


</script>
</body>

</html>
